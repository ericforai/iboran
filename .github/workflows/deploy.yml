name: Deploy to Aliyun ECS (PM2 Mode)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: corepack enable pnpm && pnpm -v

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_SERVER_URL: https://www.iboran.com
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          DATABASE_URI: mongodb://localhost:27018/iboran
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          PREVIEW_SECRET: ${{ secrets.PREVIEW_SECRET }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to server
        run: |
          # Copy build output and files to server
          tar -czf - .next public package.json pnpm-lock.yaml ecosystem.config.cjs | \
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          "cd /home/iboran && tar -xzf - && pm2 restart iboran"

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
